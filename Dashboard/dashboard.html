<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>MyKY</title>
    <style>
      body {
        position: relative;
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        font-family: Arial, sans-serif;
        overflow: hidden;
        background-image: url("../resources/Imgs/parchment_BG.jpg");
        background-size: cover;
        background-position: center;
      }
      h1 {
        margin: 20px 0 0 0;
        text-align: center;
        font-size: 2em;
        z-index: 5;
      }
      .map-container {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        top: -140px;
        max-width: 2200px;
        width: 100%;
        box-sizing: border-box;
        padding: 30px;
      }
      #map {
        width: 100%;
        height: 70vh;
      }
      #control-panel {
        position: absolute;
        top: 20px;
        left: 20px;
        background: linear-gradient(145deg, rgba(240, 240, 240, 0.95) 0%, rgba(255, 255, 255, 0.9) 100%);
        border: 5px solid;
        border-image: linear-gradient(to right, #A9A9A9, #C0C0C0, #A9A9A9) 1;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 4px 15px rgba(169, 169, 169, 0.15);
        z-index: 10;
      }
      #control-panel button {
        display: block;
        width: 100%;
        margin-bottom: 10px;
        padding: 8px 12px;
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
      }
      #control-panel button:last-child {
        margin-bottom: 0;
      }
      #control-panel button:hover {
        background: #e0e0e0;
      }
      #kill-app-btn {
        background-color: red; /* Red background */
        color: black; /* Black text */
        font-weight: bold; /* Bold text */
      }
      #kill-app-btn:hover {
        background-color: darkred;
      }
      #compass {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 200px;
        height: 300px;
        object-fit: cover;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 10;
      }
      #heraldic_shield {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 200px;
        height: 300px;
        object-fit: cover;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 10;
      }

    </style>
    <script src="mapdata.js"></script>
    <script src="countymap.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Function to load external modal HTML
        function loadModalContent(url, callback) {
          fetch(url)
            .then(response => response.text())
            .then(html => {
              const modalContainer = document.createElement('div');
              modalContainer.innerHTML = html;
              document.body.appendChild(modalContainer);
    
              // Call the callback function after the modal content has been added to the DOM
              if (callback) callback(modalContainer);
            })
            .catch(error => console.error('Error loading modal content:', error));
        }
    
        // Kill Protocol Modal functionality
        const openKillProtocolModal = function(title, content) {
          const modalOverlay = document.getElementById('kill-protocol-modal-overlay');
          const modalTitle = document.getElementById('kill-protocol-modal-title');
          
          if (modalOverlay) {
            modalTitle.textContent = title;
            // Only update content if provided, otherwise keep existing content from killProtocolModal.html
            if (content) {
              const modalContent = document.getElementById('kill-protocol-modal-content');
              modalContent.innerHTML = content;
            }
            modalOverlay.classList.add('active');
          }
        };
    
        // Close kill protocol modal function
        const closeKillProtocolModal = function() {
          const modalOverlay = document.getElementById('kill-protocol-modal-overlay');
          if (modalOverlay) {
            modalOverlay.classList.remove('active');
          }
        };
    
        // Kill Protocol Button Functionality
        document.getElementById('kill-app-btn').addEventListener('click', function() {
          // Load the modal content dynamically
          loadModalContent('killProtocolModal.html', function(modalContainer) {
            // Now that the modal is loaded, attach event listeners
            const modalClose = modalContainer.querySelector('#kill-protocol-modal-close');
            modalClose.addEventListener('click', closeKillProtocolModal);
    
            const modalOverlay = modalContainer.querySelector('#kill-protocol-modal-overlay');
            modalOverlay.addEventListener('click', function(e) {
              if (e.target === modalOverlay) {
                closeKillProtocolModal();
              }
            });
    
            // NEW: Attach the terminate button listener here, after loading
            const terminateButton = modalContainer.querySelector('#terminateButton');  // Adjust ID to match your button in killProtocolModal.html
            if (terminateButton) {
              console.log('Terminate button found, attaching listener');  // Debug log
    
              terminateButton.addEventListener('click', async () => {
                console.log('Terminate button clicked! Starting POST to /Kill');  // Debug log
    
                const button = terminateButton;
                const outputDiv = modalContainer.querySelector('#output');  // Assumes <div id="output"></div> in killProtocolModal.html
                if (!outputDiv) {
                  console.error('Output div not found in modal');
                  return;
                }
                
                button.disabled = true;
                button.textContent = 'Terminating...';
                outputDiv.innerHTML = 'Sending terminate request...';
    
                try {
                  const response = await fetch('/Kill', {  
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                  });

                  console.log('Response status:', response.status);

                  if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`Server error (${response.status}): ${error}`);
                  }

                  const data = await response.json();
                  outputDiv.innerHTML = `<p style="color: green;">Success: ${data.message}</p><pre>${data.output || 'No output'}</pre>`;

                  // Optional: Close modal after success
                  setTimeout(closeKillProtocolModal, 2000);
                } catch (error) {
                  console.error('Fetch error:', error);  // Keep for debugging

                  // NEW: Handle connection reset (server killed itself) by closing tab
                  if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    outputDiv.innerHTML = '<p style="color: orange;">Server terminatedâ€”closing dashboard...</p>';
                    console.log('Server shutdown detected; closing tab');
                    
                    // Close the tab (works if dashboard opened via script/button; else blanks it)
                    setTimeout(() => {
                      if (window.close) {
                        window.close();  // Closes if not top-level or opened by script
                      } else {
                        window.location.href = 'about:blank';  // Fallback: blank the page
                      }
                    }, 1000);  // Brief delay for message to show
                  } else {
                    // Non-shutdown error (e.g., 500)
                    outputDiv.innerHTML = `<p style="color: red;">Failed: ${error.message}</p>`;
                  }
                } finally {
                  button.disabled = false;
                  button.textContent = 'Terminate All Processes';
                }
              });
            } else {
              console.error('Terminate button (#terminateButton) not found in modal');
            }
    
            // Play audio clip when modal opens (with 0.7s delay)
            setTimeout(() => {
              const audio = new Audio('../Resources/Audio/ding.mp3');
              audio.play().catch(error => console.log('Audio play failed:', error));
            }, 450);
            
            // Open the modal after it is fully loaded (don't overwrite content)
            openKillProtocolModal('Kill Protocol Initiated');
          });
        });
    
        // Optional: Close kill protocol modal on Escape key
        document.addEventListener('keydown', function(e) {
          const modalOverlay = document.getElementById('kill-protocol-modal-overlay');
          if (e.key === 'Escape' && modalOverlay && modalOverlay.classList.contains('active')) {
            closeKillProtocolModal();
          }
        });
      });
    </script>
  </head>
  <body>
    <div id="control-panel">
      <h2>Control Panel</h2>
      <button>Sort Counties</button>
      <button>Sort Properties</button>
      <button>Scraper Dashboard</button>
      <button id="kill-app-btn">Kill Protocol</button>
    </div>
    <h1>MyKY</h1>
    <div class="map-container">
      <div id="map"></div>
    </div>
    <img id="compass" alt="Top right image" src="../resources/Imgs/compass.png"/>
    <img id="heraldic_shield" alt="Heraldic Shield of MyKY" src="../resources/Imgs/heraldic_shield.png"/>
    <!-- Modal Structure will be loaded dynamically -->
  </body>
</html>